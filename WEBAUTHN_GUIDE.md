# WebAuthn 认证使用指南

## 功能概述

本系统新增了 WebAuthn（Web 认证）功能，支持使用平台认证器（如 Windows Hello、Touch ID、Face ID）或外部安全密钥进行快速登录。

## 主要特性

1. **设备绑定**：通过邀请码绑定可信设备
2. **快速登录**：已绑定设备可跳过二重认证，直接完成登录
3. **兼容性保留**：未绑定设备仍可使用原有的账号密码 + 二重认证方式登录
4. **安全性**：基于公钥加密，凭证不会离开设备

## 使用流程

### 1. 配置环境变量

在 Vercel 项目设置中添加环境变量：

```
WEBAUTHN_INVITE_CODE=your_secure_invite_code_here
```

建议使用强随机字符串作为邀请码。

### 2. 数据库迁移

执行 `DATABASE_WEBAUTHN_MIGRATION.md` 中的 SQL 语句，创建必要的数据表。

### 3. 绑定设备

1. 在登录页面输入用户名
2. 点击"绑定新设备"按钮
3. 输入邀请码
4. 按照浏览器提示完成设备认证（如指纹、面部识别等）
5. 绑定成功后，该设备将被记录

### 4. 使用 WebAuthn 登录

1. 在登录页面输入用户名
2. 如果检测到已绑定设备，会显示"🔐 使用设备认证登录"按钮
3. 点击按钮，按照浏览器提示完成认证
4. 认证成功后直接登录，无需二重认证

### 5. 传统登录方式

未绑定设备或 WebAuthn 不可用时，仍可使用：
1. 输入用户名和密码
2. 点击"登录"按钮
3. 完成二重认证流程

## 浏览器兼容性

WebAuthn 需要以下条件：
- 现代浏览器（Chrome 67+, Firefox 60+, Safari 13+, Edge 18+）
- HTTPS 连接（本地开发可使用 localhost）
- 支持的认证器（平台认证器或外部安全密钥）

## 安全说明

1. **邀请码保护**：邀请码应妥善保管，只分享给可信用户
2. **设备安全**：WebAuthn 凭证绑定到特定设备，设备丢失应及时在数据库中删除相关凭证
3. **多设备支持**：同一用户可以绑定多个设备
4. **凭证管理**：可通过数据库查询和管理用户的 WebAuthn 凭证

## 故障排除

### WebAuthn 不可用
- 检查浏览器是否支持 WebAuthn
- 确认网站使用 HTTPS（或 localhost）
- 检查设备是否有可用的认证器

### 绑定失败
- 验证邀请码是否正确
- 检查用户名是否存在
- 查看浏览器控制台错误信息

### 认证失败
- 确认使用的是绑定时的同一设备
- 检查凭证是否在数据库中存在
- 尝试使用传统登录方式

## API 端点

- `POST /api/webauthn-check` - 检查用户是否有绑定设备
- `POST /api/webauthn-register` - 注册/绑定设备
- `POST /api/webauthn-authenticate` - WebAuthn 认证登录

## 数据库表结构

### webauthn_credentials
存储用户的 WebAuthn 凭证信息

### webauthn_challenges
临时存储认证挑战值（5分钟过期）
