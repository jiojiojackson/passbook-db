<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4361ee;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.2rem;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            background: #4361ee;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #3651d4;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.supported {
            background: #d4edda;
            color: #155724;
        }
        .status.not-supported {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebAuthn åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- æµè§ˆå™¨æ”¯æŒæ£€æµ‹ -->
        <div class="test-section">
            <h2>1. æµè§ˆå™¨æ”¯æŒæ£€æµ‹</h2>
            <p>WebAuthn API: <span id="webauthn-support" class="status">æ£€æµ‹ä¸­...</span></p>
            <p>å¹³å°è®¤è¯å™¨: <span id="platform-support" class="status">æ£€æµ‹ä¸­...</span></p>
            <div id="browser-info" class="result info" style="display:none;"></div>
        </div>

        <!-- æ£€æŸ¥ç”¨æˆ·è®¾å¤‡ç»‘å®šçŠ¶æ€ -->
        <div class="test-section">
            <h2>2. æ£€æŸ¥è®¾å¤‡ç»‘å®šçŠ¶æ€</h2>
            <input type="text" id="check-username" placeholder="è¾“å…¥ç”¨æˆ·å">
            <button onclick="checkWebAuthn()">æ£€æŸ¥</button>
            <div id="check-result" class="result" style="display:none;"></div>
        </div>

        <!-- ç»‘å®šè®¾å¤‡æµ‹è¯• -->
        <div class="test-section">
            <h2>3. ç»‘å®šè®¾å¤‡æµ‹è¯•</h2>
            <input type="text" id="bind-username" placeholder="è¾“å…¥ç”¨æˆ·å">
            <input type="password" id="bind-invite" placeholder="è¾“å…¥é‚€è¯·ç ">
            <button onclick="testBind()">å¼€å§‹ç»‘å®š</button>
            <div id="bind-result" class="result" style="display:none;"></div>
        </div>

        <!-- WebAuthn ç™»å½•æµ‹è¯• -->
        <div class="test-section">
            <h2>4. WebAuthn ç™»å½•æµ‹è¯•</h2>
            <input type="text" id="auth-username" placeholder="è¾“å…¥ç”¨æˆ·å">
            <button onclick="testAuth()">å¼€å§‹è®¤è¯</button>
            <div id="auth-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        // æ£€æµ‹æµè§ˆå™¨æ”¯æŒ
        window.addEventListener('DOMContentLoaded', () => {
            const webauthnSupport = document.getElementById('webauthn-support');
            const platformSupport = document.getElementById('platform-support');
            const browserInfo = document.getElementById('browser-info');

            if (window.PublicKeyCredential) {
                webauthnSupport.textContent = 'âœ… æ”¯æŒ';
                webauthnSupport.className = 'status supported';

                // æ£€æµ‹å¹³å°è®¤è¯å™¨
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
                    .then(available => {
                        if (available) {
                            platformSupport.textContent = 'âœ… å¯ç”¨';
                            platformSupport.className = 'status supported';
                        } else {
                            platformSupport.textContent = 'âŒ ä¸å¯ç”¨';
                            platformSupport.className = 'status not-supported';
                        }
                    });

                browserInfo.style.display = 'block';
                browserInfo.textContent = `æµè§ˆå™¨: ${navigator.userAgent}\nåè®®: ${window.location.protocol}\nä¸»æœº: ${window.location.host}`;
            } else {
                webauthnSupport.textContent = 'âŒ ä¸æ”¯æŒ';
                webauthnSupport.className = 'status not-supported';
                platformSupport.textContent = 'âŒ ä¸å¯ç”¨';
                platformSupport.className = 'status not-supported';
                
                browserInfo.style.display = 'block';
                browserInfo.className = 'result error';
                browserInfo.textContent = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ WebAuthn API\nè¯·ä½¿ç”¨ Chrome 67+, Firefox 60+, Safari 13+, æˆ– Edge 18+';
            }
        });

        // æ£€æŸ¥è®¾å¤‡ç»‘å®šçŠ¶æ€
        async function checkWebAuthn() {
            const username = document.getElementById('check-username').value;
            const resultDiv = document.getElementById('check-result');

            if (!username) {
                showResult(resultDiv, 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }

            try {
                const response = await fetch('/api/webauthn-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (response.ok) {
                    const message = data.hasWebAuthn 
                        ? `âœ… ç”¨æˆ· "${username}" å·²ç»‘å®š WebAuthn è®¾å¤‡`
                        : `âŒ ç”¨æˆ· "${username}" æœªç»‘å®š WebAuthn è®¾å¤‡`;
                    showResult(resultDiv, message, data.hasWebAuthn ? 'success' : 'info');
                } else {
                    showResult(resultDiv, `é”™è¯¯: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç»‘å®šè®¾å¤‡
        async function testBind() {
            const username = document.getElementById('bind-username').value;
            const inviteCode = document.getElementById('bind-invite').value;
            const resultDiv = document.getElementById('bind-result');

            if (!username || !inviteCode) {
                showResult(resultDiv, 'è¯·è¾“å…¥ç”¨æˆ·åå’Œé‚€è¯·ç ', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'æ­£åœ¨è¯·æ±‚ç»‘å®š...', 'info');

                // å¼€å§‹æ³¨å†Œ
                const startResponse = await fetch('/api/webauthn-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'start', username, inviteCode })
                });

                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    showResult(resultDiv, `ç»‘å®šå¤±è´¥: ${error.error}`, 'error');
                    return;
                }

                const options = await startResponse.json();
                showResult(resultDiv, 'è¯·æŒ‰ç…§æµè§ˆå™¨æç¤ºå®Œæˆè®¤è¯...', 'info');

                // åˆ›å»ºå‡­è¯
                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge: Uint8Array.from(atob(options.challenge.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0)),
                        rp: { name: options.rpName, id: options.rpId },
                        user: {
                            id: Uint8Array.from(options.userId, c => c.charCodeAt(0)),
                            name: options.userName,
                            displayName: options.userDisplayName
                        },
                        pubKeyCredParams: [
                            { type: 'public-key', alg: -7 },
                            { type: 'public-key', alg: -257 }
                        ],
                        authenticatorSelection: {
                            authenticatorAttachment: 'platform',
                            userVerification: 'preferred'
                        },
                        timeout: 60000,
                        attestation: 'none'
                    }
                });

                if (!credential) {
                    showResult(resultDiv, 'ç»‘å®šè¢«å–æ¶ˆ', 'error');
                    return;
                }

                // å®Œæˆæ³¨å†Œ
                const finishResponse = await fetch('/api/webauthn-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'finish',
                        username,
                        challenge: options.challenge,
                        credential: {
                            id: credential.id,
                            publicKey: btoa(String.fromCharCode(...new Uint8Array(credential.response.getPublicKey()))),
                            counter: 0
                        }
                    })
                });

                const result = await finishResponse.json();
                
                if (finishResponse.ok) {
                    showResult(resultDiv, `âœ… ç»‘å®šæˆåŠŸï¼\nå‡­è¯ ID: ${credential.id.substring(0, 30)}...`, 'success');
                } else {
                    showResult(resultDiv, `ç»‘å®šå¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `ç»‘å®šè¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯• WebAuthn è®¤è¯
        async function testAuth() {
            const username = document.getElementById('auth-username').value;
            const resultDiv = document.getElementById('auth-result');

            if (!username) {
                showResult(resultDiv, 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'æ­£åœ¨è¯·æ±‚è®¤è¯...', 'info');

                // å¼€å§‹è®¤è¯
                const startResponse = await fetch('/api/webauthn-authenticate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'start', username })
                });

                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    showResult(resultDiv, `è®¤è¯å¤±è´¥: ${error.error}`, 'error');
                    return;
                }

                const options = await startResponse.json();
                showResult(resultDiv, 'è¯·æŒ‰ç…§æµè§ˆå™¨æç¤ºå®Œæˆè®¤è¯...', 'info');

                // è·å–å‡­è¯
                const credential = await navigator.credentials.get({
                    publicKey: {
                        challenge: Uint8Array.from(atob(options.challenge.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0)),
                        allowCredentials: options.allowCredentials.map(cred => ({
                            type: cred.type,
                            id: Uint8Array.from(atob(cred.id.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0))
                        })),
                        rpId: options.rpId,
                        timeout: 60000,
                        userVerification: 'preferred'
                    }
                });

                if (!credential) {
                    showResult(resultDiv, 'è®¤è¯è¢«å–æ¶ˆ', 'error');
                    return;
                }

                // å®Œæˆè®¤è¯
                const finishResponse = await fetch('/api/webauthn-authenticate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'finish',
                        username,
                        challenge: options.challenge,
                        credential: { id: credential.id, counter: 0 }
                    })
                });

                const result = await finishResponse.json();
                
                if (finishResponse.ok) {
                    showResult(resultDiv, `âœ… è®¤è¯æˆåŠŸï¼\nToken: ${result.token.substring(0, 50)}...`, 'success');
                } else {
                    showResult(resultDiv, `è®¤è¯å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `è®¤è¯è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function showResult(element, message, type) {
            element.style.display = 'block';
            element.textContent = message;
            element.className = `result ${type}`;
        }
    </script>
</body>
</html>
